on: push
defaults:
  run:
    shell: pwsh

jobs:
  process-json:
    runs-on: ubuntu-latest
    container: node:latest
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_DB: postgres
          POSTGRES_PASSWORD: postgres_password
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
        ports:
          - 5432:5432
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Checkout prism repo
      uses: actions/checkout@v3
      with:
        repository: primer/prism
        path: prism

    - name: Checkout prism api repo
      uses: actions/checkout@v3
      with:
        repository: primer/api
        path: api

    - name: Prism
      shell: bash
      run: |
        cd prism
        yarn
        yarn start &

    - name: API
      shell: bash
      run: |
        cd api
        npm run setup
        npm i --save-dev prisma@latest
        npm i @prisma/client@latest
        npm run dev --w api &

    - name: Sleep 20
      shell: bash
      run: sleep 20
        
    - name: Test prism
      run: (Invoke-WebRequest -Uri  http://localhost:3000).Content

    - name: Test API
      run: (Invoke-WebRequest -Uri  http://localhost:4000).Content


    - name: Execute json downloader
      run: Invoke-WebRequest -Uri  https://www.atomcorp.dev/api/v1/themes -OutFile windows-terminal-themes.json

    - name: Parse and write
      run: ./process-json.ps1